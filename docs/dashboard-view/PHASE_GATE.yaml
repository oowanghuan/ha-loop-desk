# PHASE_GATE.yaml
# Phase Gate 规则配置文件（只定义规则，不存储状态）
# 功能模块：dashboard-view
# 版本：v1.2

meta:
  feature: "dashboard-view"
  schema_version: "1.2"
  created_at: "2024-12-30"

# ============================================================
# 功能元信息（统一事实源，用于条件判断）
# ============================================================
feature_profile:
  has_ui: true                    # 是否有 UI 组件
  demo_required: false            # Dashboard 不需要单独 Demo

# ============================================================
# Phase 1: Kickoff Gate - 规则定义
# ============================================================
phase_1_kickoff:
  required_outputs:
    - path: "10_CONTEXT.md"
      required: true
      description: "功能上下文文档"
    - path: "90_PROGRESS_LOG.yaml"
      required: true
      description: "进度日志"

  quality_checks:
    - id: context_has_goals
      description: "Context 必须明确功能目标"
      type: content_check
      target: "10_CONTEXT.md"
      anchor: "目标|Goals|Objectives"
      min_items: 2
      severity: block

    - id: context_has_non_goals
      description: "Context 必须明确 Non-Goals（不做什么）"
      type: content_check
      target: "10_CONTEXT.md"
      anchor: "不包含|Non-Goals|Out of Scope"
      min_items: 1
      severity: block

    - id: context_has_acceptance
      description: "Context 必须有验收标准"
      type: content_check
      target: "10_CONTEXT.md"
      anchor: "验收标准|Acceptance"
      min_chars: 50
      severity: warn

  approvals:
    required_roles:
      - PM

# ============================================================
# Phase 2: Spec Gate - 规则定义
# ============================================================
phase_2_spec:
  required_outputs:
    - path: "21_UI_FLOW_SPEC.md"
      required: true
      condition: "feature_profile.has_ui == true"
      description: "UI 流程规格"

  quality_checks:
    - id: spec_has_pages
      description: "SPEC 必须列出所有页面/组件"
      type: content_check
      target: "21_UI_FLOW_SPEC.md"
      anchor: "## \\d+\\."
      min_count: 1
      severity: block

    - id: spec_has_error_cases
      description: "SPEC 必须定义错误处理"
      type: content_check
      target: "21_UI_FLOW_SPEC.md"
      anchor: "错误处理|Error|异常|边界"
      min_items: 1
      severity: block

  approvals:
    required_roles:
      - Architect
      - PM

# ============================================================
# Phase 3: Demo Gate - 规则定义（跳过）
# ============================================================
phase_3_demo:
  enabled_condition: "feature_profile.demo_required == true"
  # Dashboard 不需要单独 Demo，直接在 Code 阶段验证

# ============================================================
# Phase 4: Design Gate - 规则定义
# ============================================================
phase_4_design:
  required_outputs:
    - path: "40_DESIGN_FINAL.md"
      required: true
      description: "详细设计文档"

  quality_checks:
    - id: design_has_components
      description: "Design 必须定义组件结构"
      type: content_check
      target: "40_DESIGN_FINAL.md"
      anchor: "组件|Component|Vue"
      min_items: 1
      severity: block

    - id: design_has_data_flow
      description: "Design 必须定义数据流"
      type: content_check
      target: "40_DESIGN_FINAL.md"
      anchor: "数据流|Data Flow|composable"
      severity: warn

  approvals:
    required_roles:
      - Architect

# ============================================================
# Phase 5: Code Gate - 规则定义
# ============================================================
phase_5_code:
  required_outputs:
    - path: "90_PROGRESS_LOG.yaml"
      required: true
      description: "进度日志"

  quality_checks:
    - id: all_tasks_done
      description: "所有开发任务必须完成"
      type: yaml_check
      target: "90_PROGRESS_LOG.yaml"
      field: "phase_5_code.status"
      expected: "done"
      severity: block

    - id: code_matches_design
      description: "代码必须与 Design 一致（人工确认）"
      type: manual
      severity: block

  approvals:
    required_roles:
      - Developer
      - Architect

# ============================================================
# Phase 6: Test Gate - 规则定义
# ============================================================
phase_6_test:
  required_outputs:
    - path: "60_TEST_PLAN.md"
      required: false
      description: "测试计划（可选）"

  quality_checks:
    - id: manual_test_passed
      description: "手动测试通过"
      type: manual
      checklist:
        - "Dashboard 能显示所有 Feature"
        - "点击 Feature 能跳转到 WorkspaceView"
        - "Daily Standup 正确汇总"
      severity: block

  approvals:
    required_roles:
      - QA

# ============================================================
# Phase 7: Deploy Gate - 规则定义
# ============================================================
phase_7_deploy:
  required_outputs:
    - path: "70_RELEASE_NOTE.md"
      required: false
      description: "发布说明（可选）"

  quality_checks:
    - id: integration_verified
      description: "与 WorkspaceView 集成验证"
      type: manual
      severity: block

  approvals:
    required_roles:
      - PM
